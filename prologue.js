// --- js/story/prologue.js ---

// Убедись, что window.story существует
if (!window.story) window.story = {};

Object.assign(window.story, {
  // === СЦЕНА 1: НАЧАЛО ===
  start: [
    {
      ..._.bg("black.webp"),
      ..._.music("sad_piano.mp3"),
      ..._.lockUI(),
      ..._.thought("..."),
    },
    _.horror("unknown", "ГОША...."),
    _.horror("unknown", "Гоша... Эй, ты слышишь?"),

    _.bg("ruins_blur.webp"),
    _.say("unknown", "У нас всё... Пошло не по плану, верно?"),

    _.bg("ruins_view.webp"),
    _.say("hero", "Держись, Юно, я верю, что ещё есть шанс..."),

    _.say("yuno", "Гоша, возьми...."),
    _.say("hero", "Что это?"),

    _.give("vladber_eye"),
    _.say("yuno", "Это всевидящее око Владбера."),

    _.say("hero", "Юно, ты же не хочешь сказать, что..."),

    _.music("villain_theme.mp3"),
    _.say("unknown", "О, вы всё ещё живы, толстяки?"),

    _.thought("*Чья-то тень появилась.. Это он... Он нашёл нас.*"),

    _.say("unknown", "Гоша, больше нет времени!"),

    _.thought("*Она впихивает око мне в руки и отталкивает*"),

    _.cam("quake"),
    _.bg("falling_sky.webp"),

    _.thought("*Я падаю со здания и приземляюсь на ноги.*"),
    _.say("hero", "ЮНО!!!!"),

    _.cam("flash"),
    _.bg("street_portal.webp"),
    _.thought("*Забудь об эмоциях...*"),
    _.thought("*Вижу портал, бегу к нему.*"),
    _.thought("*Око Владбера бьётся в моей руке, словно живое сердце.*"),

    { next: "prologue_fight_preparations" },
  ],

  // === СЦЕНА 2: ПОДГОТОВКА ===
  prologue_fight_preparations: [
    _.thought("*Но 3 стражника перегородили путь.....*"),
    _.say("hero", "Пошли вон, нитожества", "prologue_qte_sequence"),
  ],

  prologue_qte_sequence: [
    // Запускаем последовательность
    _.qteSeq(
      [
        // 1. Удар по первому голему (кнопка F, фон меняется на атаку)
        { k: "A", bg: "golem_fight_1" },

        // 2. Уворот и удар по второму (кнопка R)
        { k: "S", bg: "golem_fight_2" },

        // 3. Прыжок в портал через третьего (Пробел)
        { k: "W", bg: "golem_fight_3" },
      ],
      3000,
      "prologue_win",
      "prologue_qte_fail",
    ),
  ],

  prologue_qte_fail: [
    {
      ..._.bg("black.webp"), // Темный экран при смерти
      ..._.thought("*Спатанство, я всрал...*"),
    },
    _.thought(
      "*Соберись Гоша Дэр, это проще лёгкого.*",
      "prologue_qte_sequence",
    ),
  ],

  prologue_win: [
    {
      ..._.bg("portal_enter.webp"),
      ..._.music("victory_short.mp3"),
      ..._.say("hero", "Химукама кагура спасла."), // Сленг оставляем как есть
    },
    _.thought("*Вот я и у портала...*"),
    _.thought(
      "*Я должен уйти немедленно, но решил в последний раз обернуться...*",
    ),

    _.bg("ruins_destroyed.webp"), // Фон разрушений
    _.music("sad_piano.mp3"),

    _.thought("*Юно уже нет... Вернее остались лишь останки...*"),
    _.thought("*Миру конец... И этот псих идёт ко мне навстречу*"),

    _.show("villain"),
    _.say(
      "villain",
      "Ты со своей яндеркой упорно верите в возможность изменить судьбу?",
    ),
    _.say(
      "villain",
      "Гоша-Дэр, ты последний оставшийся в живых казах, и ты трусливо сбегаешь?!?!",
    ),

    _.say("hero", "Я отомщу за Юно."),

    _.thought("*Я прыгнул в портал, с полной уверенностью в моей мести.*"),

    // Переход в пустоту
    _.bg("black.webp"),
    _.music("void_whispers.mp3"), // Странный шепот

    // Пауза (можно сделать через пустой шаг с таймером, если движок умеет, или просто текст)
    _.thought(
      "*Затем пустота... Она длилась минут 10, я слышал лишь странный шёпот.*",
    ),

    _.thought("*Юно... Как я мог тебя оставить, Юно?!?*"),

    // Эффект потери памяти (текст исчезает/искажается)
    _.thought("*Юно... Кто такая Юно?*"),
    _.thought("*Где я?*"),

    {
      ..._.bg("black.webp"),
      ..._.music("void_whispers.mp3"), // Пусть шепот продолжается
      ..._.thought("*Сознание уплывает...*"),
    },

    // Эффект "тяжелых век" или затухания
    _.thought("*Веки становятся тяжелыми...*"),

    // Тишина перед сменой обстановки
    {
      ..._.bg("black.webp"),
      ..._.music("stop"), // Выключаем звук
      ..._.thought("..."), // Пауза
    },

    // ПЕРЕХОД К СНУ
    { next: "prologue_dream" },
  ],

  // === СОН ===
  prologue_dream: [
    {
      ..._.bg("black.webp"),
      ..._.music("dream_harp.mp3"),
      ..._.thought("..."),
    },

    _.bg("dream_harem.webp"),
    _.music("dream_harp.mp3"),

    // Диалоги без визуализации персонажей
    _.say(
      "girl1",
      "Гоша Дэр, ты такой сильный, я хочу, чтобы ты потрогал меня.",
    ),
    _.say("girl2", "Гошенька, позволь мне нашептать в твоё ухо."),
    _.say("girl3", "Эй, я тоже хочу нашептать в ухо Гоше!"),

    _.say(
      "hero",
      "Эй, эй, тяночки мои, не спешите. Этот мир уже захвачен нами.",
    ),
    _.say("hero", "Мы можем шептать друг другу на ухо сколько влезет."),

    _.thought("*Одна из многочисленных тянок садится на меня сверху.*"),

    _.say("dream_girl", "Ну что, Гоша, приступим?"),

    _.say("hero", "Хммм, тяночный спатанчик молодой школьницы, ахххх…"),

    _.thought("*Тянка на мне прыгает, прислоняется губами к уху*"),

    // ХОРРОР СКРИМЕР
    _.music("stop"),
    _.bg("dream_nightmare_face.webp"),

    _.horror("aida", "Твой стёпа мелкий"),

    _.thought("*Я осознаю, что внезапно эта тянка превратилась в Аиду*"),

    _.cam("quake"),
    _.music("scream.mp3"),

    _.say("hero", "ААААААААААААААА!!!!!!!!!!!!!!"),

    { next: "prologue_wakeup" },
  ],

  // === УТРО 15 ФЕВРАЛЯ ===
  prologue_wakeup: [
    _.bg("room_morning.webp"),
    _.music("morning_birds.mp3"),

    _.anim("hero", "jump"), // Тряска экрана (герой вскочил), спрайта нет
    _.say("hero", "ААААААаааа…."),

    _.say(
      "hero",
      "Обычно мои сны жестокие, но этот... Он намного жёстче обычного.",
    ),
    _.say("hero", "Видимо моё психическое состояние становится всё хуже...."),

    _.thought(
      "*Сегодня 15 февраля, мой первый день в колледже после долгого отдыха от этого позора.*",
    ),
    _.thought("*Почти 7 утра, пора вставать.*"),

    { next: "prologue_room" },
  ],

  prologue_room: [
    {
      // Устанавливаем фон комнаты
      ..._.bg("gosharoom"), // Убедись, что файл называется именно так в папке bg
      ..._.music("morning_birds.mp3"),

      // Исследование с авто-скрытием интерфейса (благодаря обновленному макросу)
      ..._.explore([
        // 1. VR ШЛЕМ (Справа сверху на полке)
        {
          x: 83,
          y: 5,
          w: 15,
          h: 12,
          item: "vr_headset",
          name: "Oculus Quest 2",
          desc: "Мой всемогущий, до сих пор актуальный, вр",
          canTake: false,
          failMsg:
            "Мне его некуда девать, да я и всё равно никогда не играю в него.",
        },

        // 2. ШЛЯПА (Справа на средней полке)
        {
          x: 85,
          y: 37,
          w: 18,
          h: 12,
          item: "hat",
          name: "Соломенная шляпа",
          desc: "Надеюсь мама до сих пор не в курсе, как я использовал эту шляпу",
          canTake: false,
          failMsg: "Не время курить.",
        },

        // 3. ФИГУРКИ (Справа снизу)
        {
          x: 83,
          y: 58,
          w: 15,
          h: 25,
          item: "figures",
          name: "Какие-то фигурки",
          desc: "Мои вайфу охраняют полку.",
          canTake: false,
          failMsg: "Иди в колледж, анимешник.",
        },

        // 4. НОУТБУК И МИКРОФОН (На столе)
        {
          x: 45,
          y: 45,
          w: 25,
          h: 20,
          item: "laptop",
          name: "Пак",
          desc: "Мой могучий пак макдак... Рад, что он всё ещё не сгорел.",
          canTake: true,
        },

        // 6. ШКАФ (Дверь слева)
        {
          x: 18,
          y: 5,
          w: 25,
          h: 65,
          item: "wardrobe",
          name: "Шкаф",
          desc: "Там мои трусики казахские.",
          canTake: false,
          failMsg: "Я пойду в колледж без трусов.",
        },

        // 7. ВЫХОД (Дверь комнаты - на фото её нет, но допустим "назад")
        // Или можно сделать зону внизу экрана "Уйти"
        {
          x: 90,
          y: 85,
          w: 10,
          h: 15,
          name: "Выйти из комнаты",
          desc: "Пора выдвигаться.",
          nextScene: "prologue_leave_home",
        },
      ]),
    },
  ],

  // === СЛЕДУЮЩАЯ СЦЕНА (ВЫХОД ИЗ ДОМА) ===
  prologue_leave_home: [
    {
      // 1. Обязательно возвращаем UI!
      ..._.showUI(),

      ..._.bg("hallway.webp"),
      ..._.say("hero", "Теперь нужно покушать."),
    },

    _.thought("*....*"),
    _.thought("*Посидеть на талкане*"),
    _.thought("*....*"),
    _.thought("*И теперь на казахскую улицу*"),
    _.thought("*Мда....*"),
    { next: "prologue_bus_trip" },
  ],

  // === СЦЕНА 2: АВТОБУС И УЧЕБА ===
  prologue_bus_trip: [
    {
      ..._.bg("bus_interior"), // Нужен фон: внутри автобуса
      ..._.music("city_traffic.mp3"), // Звуки города/автобуса
    },
    _.thought("Еду в вонючем наполненном автобусе..."),
    _.thought("Как вдруг!"),

    // Эффект замедления или акцента
    _.cam("zoom"),
    _.thought("Чей-то взгляд промелькнул в толпе..."),
    _.thought("Розовые волосы, школьная форма..."),

    _.cam("reset"),
    _.thought("Наверное, показалось."),
    _.thought("..."),

    // Переход в класс
    {
      ..._.bg("classroom_day"),
      ..._.music("class_lecture.mp3"), // Скучная лекция
      ..._.thought("Вот я в классе..."),
    },
    _.thought("Сижу... Учусь..."),
    _.thought("..."),

    _.bg("black"), // Экран темнеет (уснул)
    _.music(null), // Тишина
    { text: "...", next: "prologue_meet_yuno" },
  ],

  // === СЦЕНА 3: ПРОБУЖДЕНИЕ И ВСТРЕЧА ===
  prologue_meet_yuno: [
    {
      ..._.bg("classroom_sunset"), // Фон: класс вечером (оранжевый свет)
      ..._.music("school_evening.mp3"), // Тихая, спокойная музыка

      ..._.say("hero", "Я уснул?"),
    },
    _.thought("..."),

    // Гоша поет (можно выделить курсивом или нотами)
    _.thought("♪ Я чувствую звон в голове... и моя жизнь на грани... ♪"),
    _.thought("♪ Будто победил этот злобный мир... ♪"),

    _.anim("hero", "shake"), // Гоша встряхивается
    _.thought("*Стоп, нахера я пою?*"),

    _.thought("*Такс, походу дело все ушли домой, мне тоже пора...*"),

    // Мечта Гоши
    _.say(
      "hero",
      "Вот бы какая-нибудь красивая сталкерша за мной наблюдала...",
    ),

    // ШЕПОТ (Используем эффект horror для внезапности или просто текст)
    // Можно добавить SFX шепота
    {
      speaker: "unknown",
      text: "А я уже наблюдаю...",
      textStyle: "horror", // Красный/дрожащий текст для эффекта
      sound: "whisper.mp3",
    },

    // ИСПУГ
    _.cam("shake"), // Тряска камеры
    _.say("hero", "ЁБ ТВОЮ!"),

    _.thought("Я упал прямо на парту и повалился вместе с ней на пол."),
    _.bg("classroom_floor"), // Опционально: вид с пола (или оставить тот же)

    // ПОЯВЛЕНИЕ ЮНО
    _.music("yuno_theme.mp3"), // Загадочная/странная музыка

    _.say("unknown", "Хихи, Гошенька, ты боишься шёпота на ухо?"),

    _.thought(
      "Нет, девчонка, я боюсь, что ты увидишь, как мой спатамбреро уже рвёт трусы.",
    ),

    _.say("hero", "Шёпот... Ты меня напугала..."),
    _.thought("Она похожа на ту девушку из автобуса..."),

    _.say(
      "unknown",
      "Прости... Просто ты сказал, что хочешь, чтобы за тобой наблюдала сталкерша, вот я и решила...",
    ),

    _.say("hero", "Ты... Наблюдала за мной?"),
    _.say("unknown", "Да, Гоша, знаешь, моё сердечко..."),

    // ПЛАН ГОШИ
    _.thought("Девушка... За мной наблюдает, она влюблена?"),
    _.thought("Это мой шанс! Самое время начать действовать!"),

    // ПОБЕГ
    _.cam("flash"), // Зум на лицо (драматично)
    _.say("hero", "АААААААААА!!!!!!! СТАЛКЕРША, БЕЖАААТЬ!!!"),

    { next: "prologue_run_away" },
  ],

  // === СЦЕНА 4: ПОБЕГ ===
  prologue_run_away: [
    {
      ..._.bg("street_run"), // Размытая улица или просто улица
      ..._.music("run_comedy.mp3"), // Веселая музыка погони (Benny Hill style?)
    },

    _.say("unknown", "Не убегай!"),

    _.thought("Я выбежал на улицу, я бегу так далеко, как могу."),
    _.thought("Я, великий казах, в очередной раз бегу от своих проблем!!!"),

    _.bg("street_night"),
    _.music("run_loop.mp3"),
    _.say("hero", "Она отстала?"),
    _.thought("Я попытался обернуться, чтобы посмотреть, нет ли её сзади."),

    _.cam("quake"), // Эффект удара
    _.thought("Но тут же врезался в чьё-то маленькое тельце."),
    _.thought("Этот толстяк меня схватил и прижал к стене."),

    _.say("groza", "Попался, дылда."), // Используем ID guard для Грозы (или создай в data.js)
    _.say("hero", "Агхгха, пустииии..."),

    _.say("light", "Смотри-ка сюда."), // Лайт
    _.thought("Он показывает мне помятое фото Владбера."),

    _.say("groza", "Не узнаёшь психа?"),
    _.say("hero", "Понятия не имею!"),

    _.say("whitey", "Сейчас мы быстро тебя вернём в норму."), // Беловолосый
    _.say("hero", "Э-ЭЭ?!?! Ч-что вы делаете?"),

    _.say("groza", "Эй, расслабь свои яйца. Ща будет нормас."),

    _.bg("black"),
    _.music(null),
    _.thought("Опять темнота... Что за конченый день?!"),

    { next: "prologue_eye_vision" },
  ],

  prologue_eye_vision: [
    {
      ..._.bg("void_eye"), // Фон с Оком
      ..._.music("mystery_hum.mp3"),
    },
    _.thought("Какое-то око явилось передо мной."),
    _.thought("Оно пытается мне что-то прошептать?"),

    _.cam("flash"), // Вспышка перед видео
    _.thought("Око засияло, и тут я увидел картину..."),

    // ШАГ С ВИДЕО
    {
      video: "vision_vladber.mp4", // Файл в assets/video/
      nextScene: "prologue_after_vision", // Куда идем после видео
    },
  ],

  prologue_after_vision: [
    _.thought("Что это было?.."),
    // Продолжение следует...
  ],
});
